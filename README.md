milonga: a free nuclear reactor analysis code
=============================================

[milonga](http://www.seamplex.com/milonga/) is a free core-level neutronic code that solves the steady-state multigroup neutron transport equation (either using the diffusion approximation or the discrete ordinates $S_N$ method) over unstructured grids (although simple structured grids can also be used) using either a finite-volumes or a finite-elements discretization scheme. It works on top of the [wasora](http://www.seamplex.com/wasora) framework, which provides means to parse and understand a high-level plain-text input file containing algebraic expressions, data for function interpolation, differential equations and output instructions amongst other facilities. Therefore, any mathematical computation which can be done by wasora---i.e. parametric calculations, multidimensional optimization, function interpolation and integration, etc.---can be combined with the facilities that milonga provides to solve the neutron diffusion equation.

Its main features are:

 * free & open source software (released under the terms of the [GNU GPL version 3](http://www.gnu.org/copyleft/gpl.html))
 * solves the steady-state few-group neutron transport equation over a [Gmsh](http://geuz.org/gmsh/)-generated unstructured grid in one, two or three spatial dimensions
 * may solve either the discrete ordinates or the diffusion formulation of the transport equation
 * the method of collision probabilities is being developed by [rvignolo](https://bitbucket.org/rvignolo/milonga)
 * may use either a finite-volumes or a finite-elements spatial discretization scheme to obtain a matrix-casted eigenvalue problem
 * solves any combination of multiplicative and non-multiplicative media with and without independent source
 * can solve for either the direct or the adjoint flux (TODO! only direct flux is computed right now)
 * structured grids may be generated for simple problems within milonga without needing an external mesher (discouraged)
 * macroscopic cross sections are given as algebraic expressions of $x$, $y$ and $z$ in a per-material basis
 * algebraic expressions may involve interpolated point-wised user-defined functions of one or more variable, so cross sections may depend on intermediate spatial distributions (e.g. temperatures)
 * algebraic expressions may involve standard functions (sin, cos, exp, log, etc.) and functionals (integral, derivative, root, etc.)
 * computed results (i.e. $k_\text{eff}$, fluxes, power) are given as scalar variables and functions of $x$, $y$ and $z$ which may be further used in algebraic expressions
 * program output is 100% user-defined (in fact the program is silent if no explicit `PRINT`s are given)
 * milonga may be coupled to other calculation codes using files, shared-memory objects or python bindings
 * non-linear effects (e.g. xenon and/or thermalhydraulic feedback) may be solved in an iterative way
 * multidimensional quasi-random sequential parametric or non-linear minimization cases are easily created from single-run input files
 * milonga may be extended by runtime-loadable shared objects and/or fixed entry-point plugins
 * high-quality free & open third-party libraries are used to perform tasks that other people have already worked out: PETSc, SLEPc, GSL, IDA, Readline
 * new formulations and/or spatial discretizations schemes can be (more or less) easily added
 * milonga interfaces well with other UNIX tools (m4, grep, sed, awk, etc.) and plotting & post-processing tools (Gnuplot, Gmsh, LaTeX, ParaView, Pyxplot, etc.)
 
 

Actually, milonga can be seen as a glue layer between a mesh generator (i.e [Gmsh](http://geuz.org/gmsh/)) and a large sparse matrix solver (i.e [SLEPc](http://www.grycap.upv.es/slepc/) for eigenvalue problems and [PETSc](http://www.mcs.anl.gov/petsc/) for linear problems). That is to say, milonga builds the matrices $R$ and $F$ that cast the multigroup neutron transport/diffusion equation as a matrix-based eigenvalue problem:


$$F \phi = k_\text{eff} \cdot  R \phi $$

Should there be independent neutron sources $S$, then the problem is casted as a system of linear equations:

$$(F-R) \phi = S $$


These matrices are expected to be sparse, as they are the result of the discretization of the differential diffusion operator using either finite volumes or finite elements, over a certain spatial grid either generated by a mesher or structured defined within the milonga input file. Said matrices are thus built in [PETSc](http://www.mcs.anl.gov/petsc/) format, so they can either be passed to a parallel solver (default is [SLEPc](http://www.grycap.upv.es/slepc/), whose algorithms and parameters may be chosen at run-time) or even dumped into files to be opened later. The macroscopic cross-section may depend on the spatial coordinates $x$, $y$ and/or $z$ (depending on the dimension of the problem) not only because different materials may be assigned to the regions of the domain (i.e. physical entities) but also due to continuous dependence of these cross sections with arbitrary parameter distributions within the entity (i.e. temperatures, densities, poison concentration, etc.). These dependencies can be given either as point-wise interpolated functions or algebraic expressions (that may in turn involve point-wise defined data). 

Milonga provides also a second glue layer that links the output of the linear/eigen-solver to the input of a post-processing tool (i.e [Gmsh](http://geuz.org/gmsh/) or [ParaView](http://www.paraview.org/)). The effective multiplication factor $k_\text{eff}$ is stored as a wasora variable, and the fluxes and power distribution as point-wise defined multidimensional functions, which can then be added, subtracted, integrated, differentiated, etc. Parametric and optimization runs may be also performed.
 

The subdirectory `examples` contains a test suite that may be used as examples of usage.  
See <http://www.seamplex.com/milonga/realbook> for examples of actual applications.

Quick download, compile & check
-------------------------------

If you are impatient to run milonga (or have failed to follow the instructions in [INSTALL](INSTALL.md)), open a terminal in any GNU/Linux box (may be a VirtualBox box) and execute these commands (you can copy & paste them):

```
cd $HOME
mkdir libs
cd libs
wget -c http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-lite-3.7.1.tar.gz
tar xvzf petsc-lite-3.7.1.tar.gz 
cd petsc-3.7.1/
export PETSC_DIR=$PWD
./configure --download-fblaslapack --download-mpich --with-debugging=0
export PETSC_ARCH=arch-linux2-c-opt
make
make test
cd ..
wget -c http://slepc.upv.es/download/download.php?filename=slepc-3.7.1.tar.gz
mv download.php\?filename=slepc-3.7.1.tar.gz slepc-3.7.1.tar.gz
tar xvzf slepc-3.7.1.tar.gz
cd slepc-3.7.1/
export SLEPC_DIR=$PWD
./configure
make
make test
cd $HOME
mkdir wasora-suite
cd wasora-suite
hg clone https://bitbucket.org/wasora/wasora
cd wasora
./autogen.sh
./configure --enable-download-gsl
make
make check
cd ..
hg clone https://bitbucket.org/wasora/milonga
cd milonga
./autogen.sh
./configure
make SHELL=/bin/bash
make SHELL=/bin/bash check
cd $HOME
mkdir bin
ln -s wasora-suite/milonga/milonga bin/milonga
cat << EOF >> .bashrc
# added by milonga
export PATH=\$HOME/bin:\$PATH
export PETSC_ARCH=$PETSC_ARCH
export PETSC_DIR=$PETSC_DIR
export SLEPC_DIR=$SLEPC_DIR
EOF
```

If the above is just non-sense to you or you encounter problems with the commands (probably because you are lacking some package), either:

 a. See the detailed explanation in [INSTALL](INSTALL.md)
 b. Ask for help in the mailing list at <wasora@seamplex.com>


Running milonga
---------------

As stated above, milonga works on top of the framework provided by wasora. Actually, milonga is a plugin for wasora that can be dynamically loaded at run-time (the set of wasora plus one or more of its plugins is referred to as the _wasora suite_). Nevertheless, milonga can be compiled and executed as a stand-alone binary. In any case, milonga follows the same design principles built into wasora. See the wasora [home page](http://www.seamplex.com/wasora) and [source repository](https://bitbucket.org/wasora/milonga) for further details. 

Following a [design decision](http://talador.com.ar/jeremy/wasora/milonga/doc/WA-MI-AR-14-11D3-B.pdf), wasora (and thus milonga) reads a plain-text file referred to as the _input file_ that contains a set of alphanumeric keywords with their corresponding arguments that define a certain mathematical problem that is to be solved. See the file `examples/parser.was` that explains how wasora parses its input files.

If you obtained the source tree---either by downloading the tarball or by cloning the [mercurial repository](https://bitbucket.org/wasora/wasora/milonga)---milonga has to be compiled to obtain a binary executable (see the file `INSTALL` for details). If you downloaded a binary tarball for your architecture, the executable should be located in the root directory of the distribution. This executable can be either installed in a system-wide location (for example in `/usr/bin`), into a directory contained in the user's `$PATH` environment variable (for example in `$HOME/bin`) or even in present working directory (i.e. where the input file is). The appropriate decision is up to the user. In any case, wasora expects the name of the input file (or a path if it is not located in the current directory, although this situation may mangle the access to other needed files) as the first argument. Assuming wasora is installed in a directory listed in the `$PATH` variable and that the input file is named `input.mil`, then the proper execution instruction is

    $ milonga input.mil

See the `examples/parser.was` file, the [Examples & test suite] and [The wasora Real Book] sections below for examples of usage of valid input files.

There exist some command line options---that may be consulted using the `--help` option---that are detailed discussed in the complete documentation. In particular, the `--version` option shows information about the milonga version and the libraries it was linked against:


~~~~
$ milonga --version
milonga 0.4.14  (10996c271131 2015-11-18 08:02 -0300)
free nuclear reactor core analysis code

 rev hash 10996c271131758544a4b02123420fdb51ed1ff2
 last commit on 2015-11-18 08:02 -0300 (rev 235)
 compiled on 2015-11-19 11:35:38 by gtheler@frink (linux-gnu x86_64)
 with gcc (Debian 4.9.2-10) 4.9.2 using -O2 linked against
  SLEPc Release Version 3.6.2, Nov 03, 2015
  Petsc Release Version 3.6.2, Oct, 02, 2015  arch-linux2-c-opt
 running on Linux 3.16.0-4-amd64 #1 SMP Debian 3.16.7-ckt11-1+deb8u6 (2015-11-09) x86_64
 8  Intel(R) Core(TM) i7-3770K CPU @ 3.50GHz


 milonga is copyright (c) 2010-2015 jeremy theler
 licensed under GNU GPL version 3 or later.
 milonga is free software: you are free to change and redistribute it.
 There is NO WARRANTY, to the extent permitted by law.


---------------             ----------          ---------
wasora 0.4.19  (040eac0f20eb 2015-11-14 11:46 -0300)
wasora's an advanced suite for optimization & reactor analysis

 rev hash 040eac0f20ebbac329622568089b98582812bbd2
 last commit on 2015-11-14 11:46 -0300 (rev 173)

 compiled on 2015-11-17 08:48:31 by gtheler@frink (linux-gnu x86_64)
 with gcc (Debian 4.9.2-10) 4.9.2 using -O2 and linked against
  GNU Scientific Library version 1.16
  GNU Readline version 6.3
  SUNDIALs Library version 2.5.0


 wasora is copyright (C) 2009-2015 jeremy theler
 licensed under GNU GPL version 3 or later.
 wasora is free software: you are free to change and redistribute it.
 There is NO WARRANTY, to the extent permitted by law.

$
~~~~
    

Examples & test suite
---------------------

After the compilation of the code (that follows the standard `./configure && make` procedure, see `INSTALL` for details), one recommended step is to run the test suite with

    $ make check

It consists of ten cases that work both as examples of usage and as a suite of tests that check that milonga implements correctly the functionalities that are expected. Some cases have analytical solution and some not. Some cases used an already-generated unstructured mesh and some others need [Gmsh](http://geuz.org/gmsh/) to be installed. Some cases use [gnuplot](http://www.gnuplot.info/) to plot results. [ParaView](http://www.paraview.org/) can be used to post-process the last case. For some cases, milonga generates a markdown-formatted text file containing debugging and benchmarking information that can be converted to PDF and/or HTML with [pandoc](http://johnmacfarlane.net/pandoc/). In [Debian](http://www.debian.org)-based distributions, they can all be installed with:

    # apt-get install gmsh gnuplot paraview pandoc



The `make check` command may not show the actual output of the examples but the overall result (i.e. whether the test passed, the test failed or the test was skipped). Expect your screen to be filled up with plots, post-processing views and browsers showing debugging and benchmarking information. Each individual test may be repeated by executing the `test-*.sh` scripts located in the `examples` subdirectory.


Further information
-------------------

See the file `INSTALL` for compilation and installation instructions.  
See the directory `examples` for the test suite and other examples.  
See the contents of directory `doc` for full documentation.  

Home page: <http://www.seamplex.com/milonga>  
Repository: <http://bitbucket.org/wasora/milonga>
Mailing list and bug reports: <wasora@seamplex.com>  


milonga is copyright (C) 2009--2016 jeremy theler  
milonga is licensed under [GNU GPL version 3](http://www.gnu.org/copyleft/gpl.html) or (at your option) any later version.  
milonga is free software: you are free to change and redistribute it.  
There is NO WARRANTY, to the extent permitted by law.  
See the file `COPYING` for copying conditions.  
